<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JoJo's Shave Ice - Asana Task Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #FFD60A;
        }
        h1 {
            color: #87CEEB;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: #FF4040;
            border-color: #FF4040;
        }
        .btn-primary:hover {
            background-color: #d93333;
            border-color: #d93333;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #87CEEB;
            color: white;
            font-weight: bold;
        }
        .status-log {
            height: 400px;
            overflow-y: auto;
        }
        #login-container {
            max-width: 500px;
            margin: 100px auto;
        }
        .auth-container {
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .back-link {
            margin-bottom: 20px;
            display: inline-block;
        }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
    <!-- Login Section -->
    <div id="login-container" class="container auth-container" style="display: none;">
        <h2 class="text-center mb-4">JoJo's Shave Ice - Login</h2>
        <div id="login-message" class="mb-3"></div>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <hr>
        <button id="anonymous-login-btn" class="btn btn-secondary w-100">Continue as Guest</button>
    </div>

    <!-- Main Application Container (shown by default) -->
    <div id="app-container" class="container mt-4">
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        <h1>JoJo's Shave Ice - Asana Task Manager</h1>
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <p>This page allows you to manage the Asana integration:</p>
                    <ul>
                        <li>Configure Asana API integration</li>
                        <li>Sync tasks from Asana to Firestore</li>
                        <li>View sync status and logs</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="text-end mb-3">
            <span id="user-email" class="me-3"></span>
            <button id="logout-btn" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="managementTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-content" type="button" role="tab">
                    Configuration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="workspaces-tab" data-bs-toggle="tab" data-bs-target="#workspaces-content" type="button" role="tab">
                    Workspaces
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects-content" type="button" role="tab">
                    Projects
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync-content" type="button" role="tab">
                    Sync Tasks
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-content" type="button" role="tab">
                    Sync Logs
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="managementTabsContent">
            <!-- Configuration Tab -->
            <div class="tab-pane fade show active" id="config-content" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        Asana API Configuration
                    </div>
                    <div class="card-body">
                        <form id="config-form">
                            <div class="mb-3">
                                <label for="personalAccessToken" class="form-label">Personal Access Token</label>
                                <input type="password" class="form-control" id="personalAccessToken" placeholder="Enter your Asana Personal Access Token">
                                <div class="form-text">
                                    Create a token in <a href="https://app.asana.com/0/developer-console" target="_blank">Asana Developer Console</a>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="syncFrequency" class="form-label">Sync Frequency</label>
                                <select class="form-control" id="syncFrequency">
                                    <option value="hourly">Hourly</option>
                                    <option value="daily" selected>Daily</option>
                                    <option value="manual">Manual Only</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                            <button type="button" id="init-btn" class="btn btn-success">Initialize Asana Integration</button>
                        </form>
                        <div id="config-status" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        Current Configuration
                    </div>
                    <div class="card-body">
                        <div id="current-config">
                            <p class="text-center">Loading configuration...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Workspaces Tab -->
            <div class="tab-pane fade" id="workspaces-content" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        Asana Workspaces
                    </div>
                    <div class="card-body">
                        <div id="workspaces-list">
                            <p class="text-center">Loading workspaces...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Projects Tab (New) -->
            <div class="tab-pane fade" id="projects-content" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        Asana Projects
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <select class="form-control" id="projectWorkspaceSelect">
                                <option value="">Select a workspace...</option>
                            </select>
                        </div>
                        <div id="projects-list">
                            <p class="text-center">Select a workspace to view projects</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        Project Sync Status
                    </div>
                    <div class="card-body">
                        <div id="project-sync-status">
                            <div class="alert alert-info">
                                Select a project above to view detailed sync status
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sync Tasks Tab -->
            <div class="tab-pane fade" id="sync-content" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        Sync Tasks from Asana
                    </div>
                    <div class="card-body">
                        <form id="sync-form">
                            <div class="mb-3">
                                <label for="syncWorkspace" class="form-label">Workspace</label>
                                <select class="form-control" id="syncWorkspace">
                                    <option value="">Loading workspaces...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Sync Tasks Now</button>
                        </form>
                        <div id="sync-status" class="mt-3"></div>
                        <div class="progress mt-3" style="display: none;" id="sync-progress-container">
                            <div 
                                id="sync-progress" 
                                class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" 
                                aria-valuenow="0" 
                                aria-valuemin="0" 
                                aria-valuemax="100" 
                                style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        Task Statistics
                    </div>
                    <div class="card-body">
                        <div id="task-stats">
                            <p class="text-center">Loading statistics...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sync Logs Tab -->
            <div class="tab-pane fade" id="logs-content" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        Sync Operation Logs
                    </div>
                    <div class="card-body">
                        <div id="sync-logs">
                            <p class="text-center">Loading logs...</p>
                        </div>
                        <div class="text-center mt-3" id="load-more-logs-container" style="display: none;">
                            <button id="load-more-logs" class="btn btn-outline-primary">Load More Logs</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Log -->
        <div class="card mt-4">
            <div class="card-header">
                Status Log
            </div>
            <div class="card-body status-log">
                <div id="status-log"></div>
            </div>
            <div class="card-footer text-center">
                <button id="clear-status-log" class="btn btn-sm btn-outline-secondary">Clear Log</button>
                <button id="load-more-status" class="btn btn-sm btn-outline-primary">Load More</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase Config -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgEDfRBjbqqnwWc0TeR97V3RvfrvjJu1U",
            authDomain: "jojo-s-app-back-end.firebaseapp.com",
            projectId: "jojo-s-app-back-end",
            storageBucket: "jojo-s-app-back-end.appspot.com",
            messagingSenderId: "344579778389",
            appId: "1:344579778389:web:6a17be1a1d13b82955f1dc",
            measurementId: "G-VBP44WBTCP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
    
    <!-- Firebase Authentication -->
    <script src="js/firebase-auth.js"></script>
    
    <!-- Asana Integration Scripts -->
    <script src="js/asana-schema.js"></script>
    <script src="js/asana-sync.js"></script>
    
    <script>
        // DOM Elements for Authentication
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        
        // Initialize Asana sync utility
        const asanaSync = new AsanaSync(db);

        // DOM elements
        const statusLogDiv = document.getElementById('status-log');
        const configForm = document.getElementById('config-form');
        const initButton = document.getElementById('init-btn');
        const configStatusDiv = document.getElementById('config-status');
        const currentConfigDiv = document.getElementById('current-config');
        const workspacesListDiv = document.getElementById('workspaces-list');
        const syncForm = document.getElementById('sync-form');
        const syncWorkspaceSelect = document.getElementById('syncWorkspace');
        const syncStatusDiv = document.getElementById('sync-status');
        const syncProgressContainer = document.getElementById('sync-progress-container');
        const syncProgress = document.getElementById('sync-progress');
        const taskStatsDiv = document.getElementById('task-stats');
        const syncLogsDiv = document.getElementById('sync-logs');
        const loadMoreLogsBtn = document.getElementById('load-more-logs');
        const loadMoreLogsContainer = document.getElementById('load-more-logs-container');
        const clearStatusLogBtn = document.getElementById('clear-status-log');
        const loadMoreStatusBtn = document.getElementById('load-more-status');
        
        // Project tab elements
        const projectsListDiv = document.getElementById('projects-list');
        const projectWorkspaceSelect = document.getElementById('projectWorkspaceSelect');
        const projectSyncStatusDiv = document.getElementById('project-sync-status');

        // Authentication Event Listeners
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                loginMessage.innerHTML = '<div class="alert alert-info">Logging in...</div>';
                
                await firebaseAuth.signInWithEmailPassword(email, password);
                
                // Show app container
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Update UI with user info
                userEmailSpan.textContent = firebaseAuth.getCurrentUserEmail();
                
                // Load initial data
                initializeApp();
            } catch (error) {
                loginMessage.innerHTML = `<div class="alert alert-danger">Login failed: ${error.message}</div>`;
            }
        });
        
        anonymousLoginBtn.addEventListener('click', async function() {
            try {
                loginMessage.innerHTML = '<div class="alert alert-info">Signing in as guest...</div>';
                
                await firebaseAuth.signInAnonymously();
                
                // Show app container
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Update UI with user info
                userEmailSpan.textContent = 'Guest User';
                
                // Load initial data
                initializeApp();
            } catch (error) {
                loginMessage.innerHTML = `<div class="alert alert-danger">Anonymous login failed: ${error.message}</div>`;
            }
        });
        
        logoutBtn.addEventListener('click', async function() {
            try {
                await firebaseAuth.signOut();
                
                // Show login container
                appContainer.style.display = 'none';
                loginContainer.style.display = 'block';
                
                // Clear login form
                loginForm.reset();
                loginMessage.innerHTML = '<div class="alert alert-success">Logged out successfully.</div>';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });
        
        // Check Authentication State on Load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Skip authentication and initialize app directly
                initializeApp();
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        });
        
        // Initialize the application
        async function initializeApp() {
            addStatus("Welcome to the JoJo's Shave Ice Asana Task Manager!");
            
            // Try to recover PAT from localStorage if needed
            tryToRecoverToken();
            
            // Load current configuration
            await loadCurrentConfig();
            
            // Load workspaces
            await loadWorkspaces();
            
            // Load task statistics
            await loadTaskStats();
            
            // Load sync logs
            await loadSyncLogs();
            
            // Initialize projects tab
            initProjectsTab();
            
            // Add event listeners for log controls
            setupLogControls();
        }
        
        // Try to recover token from localStorage if it exists
        function tryToRecoverToken() {
            try {
                const savedToken = localStorage.getItem('asanaPersonalAccessToken');
                if (savedToken) {
                    console.log("Found saved token in localStorage");
                    asanaSync.personalAccessToken = savedToken;
                    addStatus("Recovered saved authentication token from local storage.");
                }
            } catch (error) {
                console.error("Error recovering token from localStorage:", error);
            }
        }
        
        // Set up log control buttons
        function setupLogControls() {
            // Clear status log button
            clearStatusLogBtn.addEventListener('click', () => {
                statusLogDiv.innerHTML = '';
                addStatus("Status log cleared.");
            });
            
            // Load more status log entries
            loadMoreStatusBtn.addEventListener('click', () => {
                addStatus("Loading additional status log entries is not implemented.");
                // This would typically load more status log entries from storage
            });
            
            // Load more sync logs button
            loadMoreLogsBtn.addEventListener('click', async () => {
                const lastLog = document.querySelector('#sync-logs table tbody tr:last-child');
                let lastTimestamp = null;
                
                if (lastLog) {
                    const lastLogId = lastLog.getAttribute('data-id');
                    if (lastLogId) {
                        const lastLogDoc = await db.collection('asana_sync_logs').doc(lastLogId).get();
                        if (lastLogDoc.exists) {
                            lastTimestamp = lastLogDoc.data().startTime;
                        }
                    }
                }
                
                await loadMoreSyncLogs(lastTimestamp);
            });
        }

        // Add status message with more detail
        function addStatus(message, isError = false) {
            const timestamp = new Date().toLocaleString();
            const statusItem = document.createElement('div');
            statusItem.className = isError ? 'alert alert-danger mb-1 py-1' : 'alert alert-info mb-1 py-1';
            statusItem.style.fontSize = '0.9rem';
            statusItem.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            statusLogDiv.appendChild(statusItem);
            statusLogDiv.scrollTop = statusLogDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Load current Asana configuration
        async function loadCurrentConfig() {
            try {
                const configDoc = await db.collection('asana_config').doc('settings').get();
                
                if (configDoc.exists) {
                    const config = configDoc.data();
                    
                    // Set form values
                    document.getElementById('syncFrequency').value = config.syncFrequency;
                    
                    // Display configuration details
                    currentConfigDiv.innerHTML = `
                        <table class="table table-bordered">
                            <tr>
                                <th>API Token</th>
                                <td>${config.personalAccessToken ? '******' : 'Not configured'}</td>
                            </tr>
                            <tr>
                                <th>Sync Enabled</th>
                                <td>${config.syncEnabled ? 'Yes' : 'No'}</td>
                            </tr>
                            <tr>
                                <th>Sync Frequency</th>
                                <td>${config.syncFrequency}</td>
                            </tr>
                            <tr>
                                <th>Default Workspace</th>
                                <td>${config.defaultWorkspaceId || 'Not set'}</td>
                            </tr>
                            <tr>
                                <th>Last Full Sync</th>
                                <td>${config.lastFullSyncTimestamp ? new Date(config.lastFullSyncTimestamp.toDate()).toLocaleString() : 'Never'}</td>
                            </tr>
                        </table>
                    `;
                    
                    // Add debug info to verify token:
                    console.log("Loaded PAT from Firestore:", config.personalAccessToken ? "Token exists (hidden)" : "No token found");
                    
                    // Store token in asanaSync object for future use
                    if (config.personalAccessToken) {
                        asanaSync.personalAccessToken = config.personalAccessToken;
                        
                        // Also store in localStorage as backup
                        try {
                            localStorage.setItem('asanaPersonalAccessToken', config.personalAccessToken);
                            console.log("Saved PAT to localStorage for persistence");
                        } catch (error) {
                            console.error("Failed to save PAT to localStorage:", error);
                        }
                    }
                    
                    addStatus("Loaded Asana configuration.");
                } else {
                    currentConfigDiv.innerHTML = `
                        <div class="alert alert-warning">
                            Asana integration is not configured yet. Please initialize the integration.
                        </div>
                    `;
                    
                    addStatus("Asana integration is not configured yet.");
                }
            } catch (error) {
                currentConfigDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading configuration: ${error.message}
                    </div>
                `;
                
                addStatus(`Error loading configuration: ${error.message}`, true);
            }
        }

        // Load workspaces
        async function loadWorkspaces() {
            try {
                const workspacesSnapshot = await db.collection('asana_workspaces').get();
                
                if (workspacesSnapshot.empty) {
                    workspacesListDiv.innerHTML = `
                        <div class="alert alert-warning">
                            No Asana workspaces found. Please initialize the integration.
                        </div>
                    `;
                    
                    syncWorkspaceSelect.innerHTML = `
                        <option value="">No workspaces available</option>
                    `;
                    
                    projectWorkspaceSelect.innerHTML = `
                        <option value="">No workspaces available</option>
                    `;
                    
                    addStatus("No Asana workspaces found.");
                } else {
                    let workspacesHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Last Sync</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    let workspaceOptions = '';
                    let projectWorkspaceOptions = '<option value="">Select a workspace...</option>';
                    
                    workspacesSnapshot.forEach(doc => {
                        const workspace = doc.data();
                        
                        workspacesHTML += `
                            <tr>
                                <td>${workspace.name}</td>
                                <td>${workspace.status}</td>
                                <td>${workspace.lastSyncTimestamp ? new Date(workspace.lastSyncTimestamp.toDate()).toLocaleString() : 'Never'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary sync-workspace-btn" data-id="${workspace.gid}">
                                        Sync Now
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        workspaceOptions += `
                            <option value="${workspace.gid}">${workspace.name}</option>
                        `;
                        
                        projectWorkspaceOptions += `
                            <option value="${workspace.gid}">${workspace.name}</option>
                        `;
                    });
                    
                    workspacesHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    workspacesListDiv.innerHTML = workspacesHTML;
                    syncWorkspaceSelect.innerHTML = workspaceOptions;
                    projectWorkspaceSelect.innerHTML = projectWorkspaceOptions;
                    
                    // Add event listeners to sync buttons
                    document.querySelectorAll('.sync-workspace-btn').forEach(button => {
                        button.addEventListener('click', async () => {
                            const workspaceId = button.getAttribute('data-id');
                            await syncWorkspace(workspaceId);
                        });
                    });
                    
                    addStatus(`Loaded ${workspacesSnapshot.size} Asana workspaces.`);
                }
            } catch (error) {
                workspacesListDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading workspaces: ${error.message}
                    </div>
                `;
                
                addStatus(`Error loading workspaces: ${error.message}`, true);
            }
        }

        // Load task statistics
        async function loadTaskStats() {
            try {
                const tasksSnapshot = await db.collection('asana_tasks').get();
                const completedTasksSnapshot = await db.collection('asana_tasks').where('completed', '==', true).get();
                
                const totalTasks = tasksSnapshot.size;
                const completedTasks = completedTasksSnapshot.size;
                const incompleteTasks = totalTasks - completedTasks;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                taskStatsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Tasks</h5>
                                    <h2>${totalTasks}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Completed</h5>
                                    <h2>${completedTasks}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Incomplete</h5>
                                    <h2>${incompleteTasks}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Completion</h5>
                                    <h2>${completionPercentage}%</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                addStatus("Loaded task statistics.");
            } catch (error) {
                taskStatsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading task statistics: ${error.message}
                    </div>
                `;
                
                addStatus(`Error loading task statistics: ${error.message}`, true);
            }
        }

        // Load sync logs
        async function loadSyncLogs() {
            try {
                const logsSnapshot = await db.collection('asana_sync_logs')
                    .orderBy('startTime', 'desc')
                    .limit(50)
                    .get();
                
                if (logsSnapshot.empty) {
                    syncLogsDiv.innerHTML = `
                        <div class="alert alert-info">
                            No sync logs found yet.
                        </div>
                    `;
                    
                    loadMoreLogsContainer.style.display = 'none';
                    addStatus("No sync logs found.");
                } else {
                    let logsHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>Project</th>
                                        <th>Status</th>
                                        <th>Duration</th>
                                        <th>Tasks</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    logsSnapshot.forEach(doc => {
                        const log = doc.data();
                        const startTime = log.startTime ? new Date(log.startTime.seconds * 1000) : null;
                        const endTime = log.endTime ? new Date(log.endTime.seconds * 1000) : null;
                        let duration = 'N/A';
                        if (startTime && endTime) {
                            const diff = (endTime - startTime) / 1000; // in seconds
                            duration = diff < 60 ? `${diff.toFixed(1)} seconds` : `${(diff / 60).toFixed(1)} minutes`;
                        }
                        
                        // Create a status badge
                        let statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                        if (log.status === 'completed') {
                            statusBadge = '<span class="badge bg-success">Completed</span>';
                        } else if (log.status === 'running') {
                            statusBadge = '<span class="badge bg-primary">Running</span>';
                        } else if (log.status === 'failed') {
                            statusBadge = '<span class="badge bg-danger">Failed</span>';
                        }
                        
                        // Summarize tasks
                        const newTasks = log.newTasks || 0;
                        const updatedTasks = log.updatedTasks || 0;
                        const failedTasks = log.failedTasks || 0;
                        const totalTasks = log.totalTasks || 0;
                        
                        const taskSummary = `
                            <div>
                                <span class="badge bg-secondary">${totalTasks} total</span>
                                ${newTasks ? `<span class="badge bg-success">${newTasks} new</span>` : ''}
                                ${updatedTasks ? `<span class="badge bg-info">${updatedTasks} updated</span>` : ''}
                                ${failedTasks ? `<span class="badge bg-danger">${failedTasks} failed</span>` : ''}
                            </div>
                        `;
                        
                        logsHTML += `
                            <tr data-id="${doc.id}">
                                <td>${startTime ? startTime.toLocaleString() : 'N/A'}</td>
                                <td>${log.projectName || 'All Projects'}</td>
                                <td>${statusBadge}</td>
                                <td>${duration}</td>
                                <td>${taskSummary}</td>
                            </tr>
                        `;
                    });
                    
                    logsHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    syncLogsDiv.innerHTML = logsHTML;
                    
                    // Show load more button if there are logs
                    loadMoreLogsContainer.style.display = 'block';
                    
                    addStatus(`Loaded ${logsSnapshot.size} sync logs.`);
                }
            } catch (error) {
                syncLogsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading sync logs: ${error.message}
                    </div>
                `;
                
                addStatus(`Error loading sync logs: ${error.message}`, true);
            }
        }
        
        // Load more sync logs function (pagination)
        async function loadMoreSyncLogs(lastTimestamp) {
            try {
                if (!lastTimestamp) {
                    addStatus("No timestamp to load older logs from.", true);
                    return;
                }
                
                // Show loading state
                loadMoreLogsBtn.disabled = true;
                loadMoreLogsBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
                
                let query = db.collection('asana_sync_logs')
                    .orderBy('startTime', 'desc')
                    .limit(20); // Load 20 more logs
                
                // Start after last timestamp
                query = query.startAfter(lastTimestamp);
                
                const logsSnapshot = await query.get();
                
                if (logsSnapshot.empty) {
                    addStatus("No more logs to load.");
                    loadMoreLogsBtn.disabled = false;
                    loadMoreLogsBtn.textContent = 'No More Logs';
                    return;
                }
                
                const tableBody = document.querySelector('#sync-logs table tbody');
                if (!tableBody) {
                    addStatus("Error: Could not find logs table.", true);
                    return;
                }
                
                let newLogsHTML = '';
                
                logsSnapshot.forEach(doc => {
                    const log = doc.data();
                    const startTime = log.startTime ? new Date(log.startTime.seconds * 1000) : null;
                    const endTime = log.endTime ? new Date(log.endTime.seconds * 1000) : null;
                    let duration = 'N/A';
                    if (startTime && endTime) {
                        const diff = (endTime - startTime) / 1000; // in seconds
                        duration = diff < 60 ? `${diff.toFixed(1)} seconds` : `${(diff / 60).toFixed(1)} minutes`;
                    }
                    
                    // Create a status badge
                    let statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                    if (log.status === 'completed') {
                        statusBadge = '<span class="badge bg-success">Completed</span>';
                    } else if (log.status === 'running') {
                        statusBadge = '<span class="badge bg-primary">Running</span>';
                    } else if (log.status === 'failed') {
                        statusBadge = '<span class="badge bg-danger">Failed</span>';
                    }
                    
                    // Summarize tasks
                    const newTasks = log.newTasks || 0;
                    const updatedTasks = log.updatedTasks || 0;
                    const failedTasks = log.failedTasks || 0;
                    const totalTasks = log.totalTasks || 0;
                    
                    const taskSummary = `
                        <div>
                            <span class="badge bg-secondary">${totalTasks} total</span>
                            ${newTasks ? `<span class="badge bg-success">${newTasks} new</span>` : ''}
                            ${updatedTasks ? `<span class="badge bg-info">${updatedTasks} updated</span>` : ''}
                            ${failedTasks ? `<span class="badge bg-danger">${failedTasks} failed</span>` : ''}
                        </div>
                    `;
                    
                    newLogsHTML += `
                        <tr data-id="${doc.id}">
                            <td>${startTime ? startTime.toLocaleString() : 'N/A'}</td>
                            <td>${log.projectName || 'All Projects'}</td>
                            <td>${statusBadge}</td>
                            <td>${duration}</td>
                            <td>${taskSummary}</td>
                        </tr>
                    `;
                });
                
                // Append new logs to existing table
                tableBody.innerHTML += newLogsHTML;
                
                // Reset button state
                loadMoreLogsBtn.disabled = false;
                loadMoreLogsBtn.textContent = 'Load More Logs';
                
                addStatus(`Loaded ${logsSnapshot.size} additional sync logs.`);
            } catch (error) {
                addStatus(`Error loading more sync logs: ${error.message}`, true);
                loadMoreLogsBtn.disabled = false;
                loadMoreLogsBtn.textContent = 'Load More Logs';
            }
        }

        // Save configuration
        configForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const personalAccessToken = document.getElementById('personalAccessToken').value.trim();
                const syncFrequency = document.getElementById('syncFrequency').value;
                
                // Check if config exists
                const configDoc = await db.collection('asana_config').doc('settings').get();
                
                // Add debugging
                console.log("Saving config - PAT provided:", personalAccessToken ? "Yes (hidden)" : "No");
                
                if (configDoc.exists) {
                    // Update existing config
                    const updateData = {
                        syncFrequency: syncFrequency,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Only update token if provided
                    if (personalAccessToken) {
                        updateData.personalAccessToken = personalAccessToken;
                        // Update in memory as well
                        asanaSync.personalAccessToken = personalAccessToken;
                        
                        // Also store in localStorage as backup
                        try {
                            localStorage.setItem('asanaPersonalAccessToken', personalAccessToken);
                            console.log("Saved PAT to localStorage for persistence");
                        } catch (error) {
                            console.error("Failed to save PAT to localStorage:", error);
                        }
                    }
                    
                    await db.collection('asana_config').doc('settings').update(updateData);
                    
                    // Verify the update
                    const updatedConfig = await db.collection('asana_config').doc('settings').get();
                    console.log("Updated config - Has PAT:", updatedConfig.data().personalAccessToken ? "Yes (hidden)" : "No");
                    
                    configStatusDiv.innerHTML = `
                        <div class="alert alert-success">
                            Configuration updated successfully!
                        </div>
                    `;
                    
                    addStatus("Configuration updated successfully.");
                } else {
                    // Create new config
                    if (!personalAccessToken) {
                        configStatusDiv.innerHTML = `
                            <div class="alert alert-danger">
                                Personal Access Token is required for initial configuration.
                            </div>
                        `;
                        
                        addStatus("Personal Access Token is required for initial configuration.", true);
                        return;
                    }
                    
                    await db.collection('asana_config').doc('settings').set({
                        version: '1.0.0',
                        personalAccessToken: personalAccessToken,
                        defaultWorkspaceId: '',
                        syncEnabled: true,
                        syncFrequency: syncFrequency,
                        lastFullSyncTimestamp: null,
                        webhookEnabled: false,
                        webhookSecret: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    configStatusDiv.innerHTML = `
                        <div class="alert alert-success">
                            Configuration created successfully! You can now initialize the integration.
                        </div>
                    `;
                    
                    addStatus("Configuration created successfully.");
                }
                
                // Reload current config
                await loadCurrentConfig();
            } catch (error) {
                configStatusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error saving configuration: ${error.message}
                    </div>
                `;
                
                addStatus(`Error saving configuration: ${error.message}`, true);
            }
        });

        // Initialize Asana integration
        initButton.addEventListener('click', async function() {
            try {
                // Check if config exists
                const configDoc = await db.collection('asana_config').doc('settings').get();
                
                if (!configDoc.exists || !configDoc.data().personalAccessToken) {
                    configStatusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            Please save a valid Personal Access Token first.
                        </div>
                    `;
                    
                    addStatus("Please save a valid Personal Access Token first.", true);
                    return;
                }
                
                configStatusDiv.innerHTML = `
                    <div class="alert alert-info">
                        Initializing Asana integration... Please wait.
                    </div>
                `;
                
                addStatus("Initializing Asana integration...");
                
                // Initialize the integration
                const result = await asanaSync.setupAsanaIntegration(configDoc.data().personalAccessToken);
                
                configStatusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <p>Asana integration initialized successfully!</p>
                        <p>Found ${result.workspaceCount} workspaces.</p>
                    </div>
                `;
                
                addStatus(`Asana integration initialized successfully! Found ${result.workspaceCount} workspaces.`);
                
                // Reload workspaces
                await loadWorkspaces();
                
                // Reload current config
                await loadCurrentConfig();
            } catch (error) {
                configStatusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error initializing Asana integration: ${error.message}
                    </div>
                `;
                
                addStatus(`Error initializing Asana integration: ${error.message}`, true);
            }
        });

        // Sync tasks form submit
        syncForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const workspaceId = syncWorkspaceSelect.value;
            
            if (!workspaceId) {
                syncStatusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Please select a workspace.
                    </div>
                `;
                
                addStatus("Please select a workspace.", true);
                return;
            }
            
            await syncWorkspace(workspaceId);
        });

        // Sync workspace tasks
        async function syncWorkspace(workspaceId) {
            try {
                syncStatusDiv.innerHTML = `
                    <div class="alert alert-info">
                        Syncing tasks from workspace... This may take a while.
                    </div>
                `;
                
                syncProgressContainer.style.display = 'block';
                syncProgress.style.width = '25%';
                syncProgress.setAttribute('aria-valuenow', '25');
                
                addStatus(`Syncing tasks from workspace ${workspaceId}...`);
                
                // Start the sync
                const result = await asanaSync.syncWorkspaceTasks(workspaceId);
                
                syncProgressContainer.style.display = 'block';
                syncProgress.style.width = '100%';
                syncProgress.setAttribute('aria-valuenow', '100');
                
                syncStatusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <p>Sync completed successfully!</p>
                        <p>Processed ${result.totalProcessed} tasks.</p>
                        <p>Created ${result.created} new tasks.</p>
                        <p>Updated ${result.updated} existing tasks.</p>
                    </div>
                `;
                
                addStatus(`Sync completed. Processed ${result.totalProcessed} tasks.`);
                
                // Hide progress bar after a delay
                setTimeout(() => {
                    syncProgressContainer.style.display = 'none';
                }, 3000);
                
                // Reload task statistics
                await loadTaskStats();
                
                // Reload sync logs
                await loadSyncLogs();
                
                // Reload workspaces
                await loadWorkspaces();
                
                // Update projects tab if the current workspace is selected
                if (projectWorkspaceSelect.value === workspaceId) {
                    loadProjectsForWorkspace(workspaceId);
                }
            } catch (error) {
                syncProgressContainer.style.display = 'none';
                
                syncStatusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error syncing tasks: ${error.message}
                    </div>
                `;
                
                addStatus(`Error syncing tasks: ${error.message}`, true);
            }
        }

        // Initialize the Projects tab
        function initProjectsTab() {
            // Add event listener to the workspace selector
            projectWorkspaceSelect.addEventListener('change', async function() {
                const workspaceId = this.value;
                if (workspaceId) {
                    await loadProjectsForWorkspace(workspaceId);
                } else {
                    projectsListDiv.innerHTML = `
                        <div class="alert alert-info">
                            Select a workspace to view projects
                        </div>
                    `;
                    projectSyncStatusDiv.innerHTML = `
                        <div class="alert alert-info">
                            Select a project to view detailed sync status
                        </div>
                    `;
                }
            });
        }
        
        // Load projects for a workspace
        async function loadProjectsForWorkspace(workspaceId) {
            try {
                projectsListDiv.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading projects...</p>
                    </div>
                `;
                
                // First check if we have the workspace projects in Firestore
                const projectsSnapshot = await db.collection('asana_projects')
                    .where('workspaceGid', '==', workspaceId)
                    .get();
                
                if (projectsSnapshot.empty) {
                    // If no projects found, try to fetch them from Asana
                    try {
                        // Save this so we automatically update the token if needed
                        if (!asanaSync.personalAccessToken) {
                            const configDoc = await db.collection('asana_config').doc('settings').get();
                            if (configDoc.exists && configDoc.data().personalAccessToken) {
                                asanaSync.personalAccessToken = configDoc.data().personalAccessToken;
                            }
                        }
                        
                        // Fetch projects directly from Asana
                        const projects = await asanaSync.getProjects(workspaceId);
                        
                        if (projects && projects.length > 0) {
                            // Save projects to Firestore
                            const batch = db.batch();
                            
                            for (const project of projects) {
                                const projectRef = db.collection('asana_projects').doc(project.gid);
                                batch.set(projectRef, {
                                    gid: project.gid,
                                    name: project.name,
                                    workspaceGid: workspaceId,
                                    status: 'active',
                                    lastSyncTimestamp: null,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            await batch.commit();
                            addStatus(`Saved ${projects.length} projects from Asana to Firestore.`);
                            
                            // Display the projects
                            displayProjects(projects, workspaceId);
                        } else {
                            projectsListDiv.innerHTML = `
                                <div class="alert alert-warning">
                                    No projects found in this workspace.
                                </div>
                            `;
                        }
                    } catch (error) {
                        projectsListDiv.innerHTML = `
                            <div class="alert alert-danger">
                                Error fetching projects from Asana: ${error.message}
                            </div>
                        `;
                        addStatus(`Error fetching projects from Asana: ${error.message}`, true);
                    }
                } else {
                    // Convert the snapshot to an array of projects
                    const projects = [];
                    projectsSnapshot.forEach(doc => {
                        projects.push(doc.data());
                    });
                    
                    // Display the projects
                    displayProjects(projects, workspaceId);
                }
            } catch (error) {
                projectsListDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading projects: ${error.message}
                    </div>
                `;
                addStatus(`Error loading projects: ${error.message}`, true);
            }
        }
        
        // Display projects in the UI
        function displayProjects(projects, workspaceId) {
            if (projects.length === 0) {
                projectsListDiv.innerHTML = `
                    <div class="alert alert-warning">
                        No projects found in this workspace.
                    </div>
                `;
                return;
            }
            
            let projectsHTML = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Last Sync</th>
                                <th>Tasks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            projects.forEach(project => {
                let syncStatus = 'Never synced';
                let syncStatusClass = 'text-warning';
                
                if (project.lastSyncTimestamp) {
                    const syncDate = new Date(project.lastSyncTimestamp.seconds * 1000);
                    syncStatus = syncDate.toLocaleString();
                    syncStatusClass = 'text-success';
                }
                
                projectsHTML += `
                    <tr>
                        <td class="project-name" data-id="${project.gid}">${project.name}</td>
                        <td>${project.status || 'active'}</td>
                        <td class="${syncStatusClass}">${syncStatus}</td>
                        <td>${project.taskCount || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-primary sync-project-btn" data-id="${project.gid}" data-workspace="${workspaceId}">
                                Sync Now
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            projectsHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            projectsListDiv.innerHTML = projectsHTML;
            
            // Add event listeners for sync buttons
            document.querySelectorAll('.sync-project-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const projectId = button.getAttribute('data-id');
                    const workspaceId = button.getAttribute('data-workspace');
                    await syncProject(projectId, workspaceId);
                });
            });
            
            // Add event listeners for project names (to show detailed status)
            document.querySelectorAll('.project-name').forEach(element => {
                element.addEventListener('click', async () => {
                    const projectId = element.getAttribute('data-id');
                    await showProjectDetails(projectId);
                });
                // Make it look clickable
                element.style.cursor = 'pointer';
                element.style.color = '#0d6efd';
                element.style.textDecoration = 'underline';
            });
            
            addStatus(`Loaded ${projects.length} projects.`);
        }
        
        // Show detailed project information
        async function showProjectDetails(projectId) {
            try {
                projectSyncStatusDiv.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading project details...</p>
                    </div>
                `;
                
                // Get project from Firestore
                const projectDoc = await db.collection('asana_projects').doc(projectId).get();
                
                if (!projectDoc.exists) {
                    projectSyncStatusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            Project details not found.
                        </div>
                    `;
                    return;
                }
                
                const project = projectDoc.data();
                
                // Get project tasks
                const tasksSnapshot = await db.collection('asana_tasks')
                    .where('projectGids', 'array-contains', projectId)
                    .get();
                
                const totalTasks = tasksSnapshot.size;
                
                // Get completed tasks
                const completedTasksSnapshot = await db.collection('asana_tasks')
                    .where('projectGids', 'array-contains', projectId)
                    .where('completed', '==', true)
                    .get();
                
                const completedTasks = completedTasksSnapshot.size;
                const incompleteTasks = totalTasks - completedTasks;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                // Get project sync logs
                const logsSnapshot = await db.collection('asana_sync_logs')
                    .where('projectId', '==', projectId)
                    .orderBy('startTimestamp', 'desc')
                    .limit(5)
                    .get();
                
                let logsHTML = '';
                
                if (!logsSnapshot.empty) {
                    logsHTML = `
                        <h5 class="mt-4">Recent Sync Activity</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>Status</th>
                                        <th>Tasks Processed</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    logsSnapshot.forEach(doc => {
                        const log = doc.data();
                        const startTime = log.startTimestamp 
                            ? new Date(log.startTimestamp.seconds * 1000).toLocaleString() 
                            : 'N/A';
                        
                        logsHTML += `
                            <tr>
                                <td>${startTime}</td>
                                <td>
                                    <span class="badge ${log.status === 'success' ? 'bg-success' : 'bg-danger'}">
                                        ${log.status}
                                    </span>
                                </td>
                                <td>${log.totalProcessed || 0}</td>
                            </tr>
                        `;
                    });
                    
                    logsHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    logsHTML = `
                        <div class="alert alert-info mt-4">
                            No sync logs found for this project.
                        </div>
                    `;
                }
                
                projectSyncStatusDiv.innerHTML = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h4 class="card-title">${project.name}</h4>
                            <p class="card-text">
                                <strong>Last Synced:</strong> ${project.lastSyncTimestamp 
                                    ? new Date(project.lastSyncTimestamp.seconds * 1000).toLocaleString() 
                                    : 'Never'}
                            </p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Tasks</h5>
                                    <h2>${totalTasks}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Completed</h5>
                                    <h2>${completedTasks}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Incomplete</h5>
                                    <h2>${incompleteTasks}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Completion</h5>
                                    <h2>${completionPercentage}%</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${logsHTML}
                    
                    <div class="mt-4">
                        <button class="btn btn-primary sync-project-detail-btn" data-id="${projectId}" data-workspace="${project.workspaceGid}">
                            Sync Project Now
                        </button>
                    </div>
                `;
                
                // Add event listener to the sync button
                document.querySelector('.sync-project-detail-btn').addEventListener('click', async () => {
                    const projectId = document.querySelector('.sync-project-detail-btn').getAttribute('data-id');
                    const workspaceId = document.querySelector('.sync-project-detail-btn').getAttribute('data-workspace');
                    await syncProject(projectId, workspaceId);
                });
                
                addStatus(`Loaded details for project: ${project.name}`);
            } catch (error) {
                projectSyncStatusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading project details: ${error.message}
                    </div>
                `;
                addStatus(`Error loading project details: ${error.message}`, true);
            }
        }
        
        // Sync a specific project
        async function syncProject(projectId, workspaceId) {
            try {
                // Update UI to show syncing
                const syncButton = document.querySelector(`.sync-project-btn[data-id="${projectId}"]`);
                if (syncButton) {
                    syncButton.disabled = true;
                    syncButton.innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Syncing...
                    `;
                }
                
                const detailSyncButton = document.querySelector('.sync-project-detail-btn');
                if (detailSyncButton && detailSyncButton.getAttribute('data-id') === projectId) {
                    detailSyncButton.disabled = true;
                    detailSyncButton.innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Syncing...
                    `;
                }
                
                addStatus(`Syncing project ${projectId}...`);
                
                // Create a sync log entry
                const syncLogRef = await db.collection('asana_sync_logs').add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    operation: 'project_sync',
                    status: 'in_progress',
                    workspaceGid: workspaceId,
                    projectId: projectId,
                    startTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    totalProcessed: 0,
                    created: 0,
                    updated: 0,
                    errors: []
                });
                
                try {
                    // Initialize Asana client if needed
                    if (!asanaSync.personalAccessToken) {
                        const configDoc = await db.collection('asana_config').doc('settings').get();
                        if (configDoc.exists && configDoc.data().personalAccessToken) {
                            asanaSync.personalAccessToken = configDoc.data().personalAccessToken;
                        } else {
                            throw new Error('Asana API token not configured');
                        }
                    }
                    
                    // Get project from Asana
                    const projectData = await asanaSync.makeAsanaRequest(`/projects/${projectId}/tasks?opt_fields=name,assignee,completed,due_on,due_at,notes,html_notes,tags,projects,parent,created_at,modified_at,completed_at,followers`);
                    
                    if (!projectData || !projectData.data) {
                        throw new Error('Failed to fetch project tasks from Asana');
                    }
                    
                    const tasks = projectData.data;
                    
                    // Create a batch for efficient writing
                    let batch = db.batch();
                    let batchCount = 0;
                    let stats = {
                        totalProcessed: 0,
                        created: 0,
                        updated: 0,
                        errors: []
                    };
                    
                    // Process each task
                    for (const task of tasks) {
                        try {
                            const firestoreTask = asanaSync.convertTaskToFirestoreFormat(task, workspaceId);
                            const taskRef = db.collection('asana_tasks').doc(task.gid);
                            
                            // Check if task exists
                            const existingTask = await taskRef.get();
                            
                            if (existingTask.exists) {
                                batch.update(taskRef, firestoreTask);
                                stats.updated++;
                            } else {
                                batch.set(taskRef, firestoreTask);
                                stats.created++;
                            }
                            
                            batchCount++;
                            stats.totalProcessed++;
                            
                            // Commit in batches of 500
                            if (batchCount >= 500) {
                                await batch.commit();
                                batch = db.batch();
                                batchCount = 0;
                            }
                        } catch (error) {
                            console.error(`Error processing task ${task.gid}:`, error);
                            stats.errors.push({
                                taskGid: task.gid,
                                error: error.message
                            });
                        }
                    }
                    
                    // Commit any remaining batches
                    if (batchCount > 0) {
                        await batch.commit();
                    }
                    
                    // Update the project's last sync timestamp and task count
                    await db.collection('asana_projects').doc(projectId).update({
                        lastSyncTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        taskCount: stats.totalProcessed,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update the sync log
                    await syncLogRef.update({
                        status: 'success',
                        endTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        totalProcessed: stats.totalProcessed,
                        created: stats.created,
                        updated: stats.updated,
                        errors: stats.errors
                    });
                    
                    addStatus(`Project sync completed. Processed ${stats.totalProcessed} tasks.`);
                    
                    // Reload projects to show updated sync status
                    await loadProjectsForWorkspace(workspaceId);
                    
                    // Reload project details if it's the current selection
                    if (detailSyncButton && detailSyncButton.getAttribute('data-id') === projectId) {
                        await showProjectDetails(projectId);
                    }
                    
                    // Update tasks stats
                    await loadTaskStats();
                } catch (error) {
                    // Update the sync log with error
                    await syncLogRef.update({
                        status: 'failure',
                        endTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        errors: [{ error: error.message }]
                    });
                    
                    addStatus(`Error syncing project: ${error.message}`, true);
                    
                    // Reset sync buttons
                    if (syncButton) {
                        syncButton.disabled = false;
                        syncButton.textContent = 'Sync Now';
                    }
                    
                    if (detailSyncButton && detailSyncButton.getAttribute('data-id') === projectId) {
                        detailSyncButton.disabled = false;
                        detailSyncButton.textContent = 'Sync Project Now';
                    }
                }
            } catch (error) {
                addStatus(`Error initiating project sync: ${error.message}`, true);
                
                // Reset sync buttons
                const syncButton = document.querySelector(`.sync-project-btn[data-id="${projectId}"]`);
                if (syncButton) {
                    syncButton.disabled = false;
                    syncButton.textContent = 'Sync Now';
                }
                
                const detailSyncButton = document.querySelector('.sync-project-detail-btn');
                if (detailSyncButton && detailSyncButton.getAttribute('data-id') === projectId) {
                    detailSyncButton.disabled = false;
                    detailSyncButton.textContent = 'Sync Project Now';
                }
            }
        }
    </script>
</body>
</html> 